<!DOCTYPE html>

<html>

  	<head>
	  	<meta charset="utf-8">
	    <title>Coronavirus no Brasil</title>


	    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>


	    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

	    <script type="text/javascript" src="data/UF.js"></script>
		<link rel="stylesheet" href="css/dc.css">
		<script src="js/crossfilter.js" charset="utf-8"></script>
	    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	    <script src="js/dc.js" charset="utf-8"></script>
	    <script src="https://d3js.org/colorbrewer.v1.min.js"></script>

		
		
	    <style type="text/css">
	      	#mapid { width: 90%; height: 1000px;}
	      	/*#chart { width: 40%; }*/
			.info {
				padding: 6px 8px;
				font: 22px/24px Arial, Helvetica, sans-serif;
				background: white;
				background: rgba(255,255,255,0.8);
				box-shadow: 0 0 15px rgba(0,0,0,0.2);
				border-radius: 5px;
			}

			.Row {
				padding: 6px 8px;
				font: 10px/16px Arial, Helvetica, sans-serif;
				background: white;
				background: rgba(255,255,255,0.8);
				box-shadow: 0 0 15px rgba(0,0,0,0.2);
				border-radius: 5px;
			}
			.info h3 {
				margin: 0 0 5px;
				color: #777;
			}
			.info i {

				margin-top: 5px;
				height: 20px;
				float: left;
				opacity: 1;
			}

			.legend {
				text-align: left;
				line-height: 25px;
				color: #555;
			}
			.legend i {
				width: 18px;
				height: 18px;
				float: left;
				margin-right: 8px;
				opacity: 0.7;
			}

					/* The switch - the box around the slider */
			.switch {
			  position: relative;
			  display: inline-block;
			  width: 60px;
			  height: 28px;
			}

			/* Hide default HTML checkbox */
			.switch input {
			  opacity: 0;
			  width: 0;
			  height: 0;
			}

			/* The slider */
			.slider {
			  position: absolute;
			  cursor: pointer;
			  top: 0;
			  left: 0;
			  right: 0;
			  bottom: 0;
			  background-color: #e34a33;
			  opacity: 0.5;
			  -webkit-transition: .4s;
			  transition: .4s;
			}

			.slider:before {
			  position: absolute;
			  content: "";
			  height: 20px;
			  width: 20px;
			  left: 4px;
			  bottom: 4px;
			  background-color: white;
			  -webkit-transition: .4s;
			  transition: .4s;
			}

			input:checked + .slider {
			  background-color: #000000;
			}

			input:focus + .slider {
			  box-shadow: 0 0 1px #2196F3;
			}

			input:checked + .slider:before {
			  -webkit-transform: translateX(26px);
			  -ms-transform: translateX(26px);
			  transform: translateX(26px);
			}

			/* Rounded sliders */
			.slider.round {
			  border-radius: 34px;
			}

			.slider.round:before {
			  border-radius: 50%;
			}

			.dc-chart g.row text {
		      fill: black;
		      padding: 6px 8px;
				font: 14px/16px Arial, Helvetica, sans-serif;
				background: white;
				background: rgba(255,255,255,0.8);
		    }
		    .dc-chart g.row {
		      height: 30px;
		    }
	    </style>
	    <link rel="stylesheet" href="https://cajazeiraramos.github.io/css/style.css">
	    <link rel="stylesheet" href="https://cajazeiraramos.github.io/assets/site1.css">

  	</head>

  	<body style="margin-left: 5%; margin-top: 100px;">

        
		<nav class="nav"> 
			<ul class="list"> 
				<li class="item"> 
					<a class="link" href="https://cajazeiraramos.github.io/Covid19">Covid19 - PI</a> 
				</li>
				<li class="item"> 
					<a class="link" href="https://cajazeiraramos.github.io/">Home</a> 
				</li> 
				<li class="item"> <a class="link" href="https://cajazeiraramos.github.io/about">About</a> 
				</li> 
			</ul>
		 </nav>
  		

		<!-- <h1> Coronavírus no Brasil</h1> -->
		<div id="mapid"></div>
		<p>*Fonte: <a href="https://covid.saude.gov.br/">Ministério da Saúde</a> e <a href="https://www.ibge.gov.br/apps/populacao/projecao/index.html?utm_source=portal&utm_medium=popclock&utm_campaign=novo_popclock">IBGE</a></p>

		<div id="DashBoard">
			<!-- <h3>Valores Absolutos: Casos confirmados por estado.</h3>  -->
			<!-- <div id="Row2"></div> -->

		</div>
		<!-- https://covid.saude.gov.br/ -->
			
	    <script>
	    	var currentUF = "";
	 		var BarraSelecionada = false;   	

	    	var chart;

	    	// var chart2 = new dc.rowChart("#Row2");

			// Mapa: 

			var Escala = 0; //0 para Taxa, 1 para letatidade.
			let geojson; 

			let TotalCasos = 0,
			TotalMortes = 0,
			ConfByUF = d3.map(),
			MortesByUF = d3.map(),
			PopByUF = d3.map(),
			NomeByUF = d3.map(),
			TaxaByUF = d3.map(),
			LetByUF = d3.map();

			let quantize = getQuantize(Escala),
			info = L.control(),  							//Dados por estado
			legend = L.control({position: 'bottomright'}),  //Legenda de Cores
			title = L.control({position: 'topright'}),    //Geral; 
			teste = L.control({position: 'bottomleft'});

	    	// Funções auxiliares para alternar mapas e escalas(ESC);
	    	
	    	function getColors(Esc){
	    		if(Esc == 0){
					return colorbrewer.Reds[6];
	    		}
	    		// return colorbrewer.Reds[7];
	    		return ['#f7f7f7','#d9d9d9','#bdbdbd','#969696','#737373','#525252','#252525'];}
	    	function getQuantize(Esc){
	    		if(Esc == 0){
	    			return (d3.scale.linear()
					    .domain([0,3,6,9,12,15])
					    .range(getColors(Escala)));
	    		}
	    		return (d3.scale.linear()
		    		.domain([0,1,3,5,7,10,15])
		    		.range(getColors(Escala)));}
	    	function getIndicador(Esc, id){
	    		if(Esc == 0){
	    			return TaxaByUF.get(id);
	    		}
	    			return LetByUF.get(id);}
	    	function getLabelsTitle(Esc){
	    		if(Esc == 0){
	    			return ("<b>Taxa por 100 mil/h </b> ");
	    		}
	    			return ("<b>Letalidade (%)</b> ");}


	    	var Centro = [-13.360272, -51.805698];
	      	var Mapa = L.map('mapid').setView(Centro, 4);

	      	L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {maxZoom: 18, attribution: `&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>`}).addTo(Mapa);


	      	// Lendo CSV com D3: 

			d3.csv("data/covid19Br.csv", function(data){
			        
			    data.forEach(function(d) {
			           	
			    	d.nome = d.Nome;
			        d.id = d.UF;
			        d.pop = +d.Pop;
			        d.conf = +d.Confirmados;
			        d.mortes = +d.Mortes;
			        d.taxa = (d.conf*100000)/d.pop; // Taxa de casos por 100 mil habitantes; 
			        d.t = d3.round(d.taxa, 2);  
			        d.let = d3.round(((d.mortes*100)/d.conf),2); //Letalidade

			        TotalCasos+=d.conf;
			        TotalMortes+=d.mortes;
			           	
			        NomeByUF.set(d.id, d.Nome);
			        ConfByUF.set(d.id,d.conf);
			        MortesByUF.set(d.id,d.mortes); 
			        PopByUF.set(d.id,d.pop);
			        TaxaByUF.set(d.id, d.t); 
			        LetByUF.set(d.id, d.let);
			    });

			    var facts = crossfilter(data),
				UF_DIM = facts.dimension(function(d){
				    return d.id;
				}),
				confGroup = UF_DIM.group().reduceSum(function(d){
					return d.conf;
				});

				taxaGroup = UF_DIM.group().reduceSum(function(d){
					return d3.round(d.taxa,2);
				});

				letGroup = UF_DIM.group().reduceSum(function(d){
					return d3.round(d.let,2);
				});
				
				// console.log(document.getElementById('mapid').style);

				// chart2
				// 	.width(1200)
				// 	.height(900)
				// 	.margins({top: 5, left: 5, right: 10, bottom: 20})
				// 	.renderTitleLabel(true)
				// 	.renderLabel(true)
				// 	.controlsUseVisibility(false)
				// 	.legend(dc.legend().x(700).y(5).itemHeight(13).gap(5))
				// 	.elasticX(true)
				// 	.dimension(UF_DIM)
				// 	.group(confGroup)
				// 	.colors(function(d){

				// 	    	let quantize = getQuantize(Escala),
				// 	    	ind = getIndicador(Escala, d),
			 //    			cor = quantize(ind);
			 //    			return quantize(ind);


				// 	    })
				// 	    .addFilterHandler(function (filters, filter) {
				// 	        filters.length = 0; // empty the array
				// 	        filters.push(filter);
				// 	        return filters;
				// 	    })
				// 	    .render();	

				// d3.selectAll('g.row').on('click', function(d){
				// 	if(currentUF == d.key && !MapaCentralizado()){
				// 		ResetMap();
				// 		info.update();
				// 	}else{
				// 		var layer = getLayerByUF(d.key);
				// 		zoomToFeaturev2(layer);
				// 		currentUF = d.key;	
	
				// 	}
					
				// });
				

				   

				geojson = L.geoJson(Estados, {
					style: style,
					onEachFeature: onEachFeature
				}).addTo(Mapa);	

				title.onAdd = function (mymap) {
					
					let div = L.DomUtil.create('div', 'info legend'),
						labels = [];

					    labels.push("<b>Brasil - 05 de Abril de 2020: </b> ");
						labels.push('<i style=" background:#e34a33"></i> '+"Total de casos confirmados: <b>"+TotalCasos+"</b>");
						labels.push('<i style=" background:black"></i> '+"Total de óbitos: <b>"+TotalMortes+"</b>");
					
						let taxaBR = d3.round((TotalCasos*100000)/210147125,2),
						letBr = d3.round(((TotalMortes*100)/TotalCasos),2);

						labels.push(taxaBR+' casos por 100 mil / h');
						labels.push('Letalidade: '+letBr+'%');
						
						var seletor = '<b>Mapa (Taxa de Casos / Letalidade):</b> <br> Escolha:   <label class="switch">' + 
							'<input type="checkbox" id="DefMap" onchange="Att()">' + 
							'<span class="slider round"></span>' + 
							'</label>';

						labels.push(seletor);				
						div.innerHTML = labels.join('<br>');
						return div;};
				info.onAdd = function (map) {
					this._div = L.DomUtil.create('div', 'info');
					this.update();
					return this._div;};
				info.update = function (e) {
					if(e){
						var UF = e.properties;
						var id = UF.UF, 
						Nome = NomeByUF.get(id),
						conf = ConfByUF.get(id),
						mortes = MortesByUF.get(id),
						taxa = TaxaByUF.get(id),
						pop = PopByUF.get(id),
						let = LetByUF.get(id);

						var quantize = getQuantize(Escala),
		    			ind = getIndicador(Escala, id),
		    			cor = quantize(ind);
					//  + 'População: ' + pop + '<br /><br />' 
					}
					this._div.innerHTML = '<h3>Dados por estado* </h3>' +  (e ?
								'<b>' + Nome + '</b><br />' + conf + ' Casos confirmados' + '</b><br />' + mortes + ' Óbito(s)' + '</b><br />' + taxa + ' para cada 100mil/h'+ '</b><br />' + let + '% Letalidade'+ '</b><br />'+
								'<i style="margin-left:25%; width:'+let+'px; background:black"></i>'+ '<i id="casos" style="width:'+(100-let)+'px; background:'+cor+'"></i>' 
								: 'Passe o mouse sobre seu Estado ou click');};
				legend.onAdd = function (map) {
					var brewerColors = getColors(Escala);
					let div = L.DomUtil.create('div', 'info legend'),
					labels = [],
					n = brewerColors.length,
					from, to;
					labels.push(getLabelsTitle(Escala));
					for (let i = 0; i < n; i++) {
						let c = brewerColors[i];
					    let fromto = quantize.domain();//.invertExtent(c);
						labels.push(
							'<i style="background:' + brewerColors[i] + '"></i> ' +
							d3.round(fromto[i],1) + (d3.round(fromto[i+1],1) ? ' &ndash; ' + d3.round(fromto[i+1],1) : '+'));
					}

					div.innerHTML = labels.join('<br>');
					return div;};
				
				teste.onAdd = function(mymap){
					let div = L.DomUtil.create('div', 'Row'),
					labels = [];
					div.id = "Row";
					div.innerHTML = labels.join('<br>');
					return div;
				}

				title.addTo(Mapa);
				info.addTo(Mapa);
				legend.addTo(Mapa);
				teste.addTo(Mapa);

				chart = new dc.rowChart("#Row")
				chart
					.width(300)
					.height(500)
					.margins({top: 5, left: 5, right: 10, bottom: 20})
					.renderTitleLabel(false)
					.renderLabel(true)
					.controlsUseVisibility(false)
					.legend(dc.legend().x(700).y(5).itemHeight(13).gap(5))
					.elasticX(true)
					.dimension(UF_DIM)
					.group(taxaGroup)
					.colors(function(d){

						let quantize = getQuantize(Escala),
					    ind = getIndicador(Escala, d),
			    		cor = quantize(ind);
			    		return quantize(ind);


					})
					.addFilterHandler(function (filters, filter) {
					    filters.length = 0; // empty the array
					    filters.push(filter);
					    return filters;
					})
					.render();


				
				
			});	
			function Att(){

	    		if(document.getElementById("DefMap").checked === true)
					Escala = 1;
				else
				  	Escala = 0;	  
				  
				if(geojson)Mapa.removeLayer(geojson);

				quantize = getQuantize(Escala);
				geojson = L.geoJson(Estados, {
					style: style,
					onEachFeature: onEachFeature
				}).addTo(Mapa);	

				legend.addTo(Mapa);

				if(Escala == 0){
					chart.group(taxaGroup);
				}else{
					chart.group(letGroup);
				}

				chart
				 	.colors(function(d){
					   	let ind = getIndicador(Escala, d),
			    		cor = quantize(ind);
			    		return quantize(ind);
					}).render();

				// chart2
				//  	.colors(function(d){
				// 	   	let ind = getIndicador(Escala, d),
			 //    		cor = quantize(ind);
			 //    		return quantize(ind);
				// 	})
				// 	.render();
				
				d3.selectAll('g.row').on('click', function(d){
					if(currentUF == d.key && !MapaCentralizado()){
						ResetMap();
						info.update();
					}else{
						var layer = getLayerByUF(d.key);
						zoomToFeaturev2(layer);
						currentUF = d.key;	
	
					}
					
				});


				d3.selectAll('g.row').on('mouseover', function(d){
					
					var layer = getLayerByUF(d.key);
					highlightFeaturev2(layer);
						
				});

				d3.selectAll('g.row').on('mouseout', function(d){
					var layer = getLayerByUF(d.key);
					geojson.resetStyle(layer);
					info.update();
				})

				}  //Alterar Mapas;

			// Funções auxiliares para manipular features no leaflet; 

		    function style(feature) {
		    	var quantize = getQuantize(Escala);
		    	var ind = getIndicador(Escala, feature.properties.UF);
		    	return {
					weight: 2,
					opacity: 1,
					color: '#AAA',
					dashArray: '3',
					fillOpacity: 1,
					fillColor: quantize(ind)
				};}
			function highlightFeature(e) {
				let layer = e.target;

				layer.setStyle({
							weight: 3,
							color: 'black',
							dashArray: '',
							fillOpacity: 0.7
				});

				if (!L.Browser.ie && !L.Browser.opera) {
					layer.bringToFront();
				}

				info.update(layer.feature);}
			function highlightFeaturev2(layer) {
				
				layer.setStyle({
							weight: 3,
							color: 'black',
							dashArray: '',
							fillOpacity: 0.7
				});

				if (!L.Browser.ie && !L.Browser.opera) {
					layer.bringToFront();
				}

				info.update(layer.feature);}


			function resetHighlight(e) {
				geojson.resetStyle(e.target);
				info.update();}
			function zoomToFeature(e){
				if(currentUF == e.target.feature.properties.UF && !MapaCentralizado()){
					ResetMap();
					info.update();
				}else{
					currentUF = e.target.feature.properties.UF;
					Mapa.fitBounds(e.target.getBounds());
					info.update(e.target.feature);
				}}
			function onEachFeature(feature, layer) {
				layer._leaflet_id = feature.properties.UF;
				// console.log(feature.properties.UF);   
				layer.on({
							mouseover: highlightFeature,
							mouseout: resetHighlight,
							click: zoomToFeature
						});}
			function zoomToFeaturev2(layer){
				Mapa.fitBounds(layer.getBounds());
				info.update(layer.feature);}
			function getLayerByUF(UF){

				return(geojson._layers[UF]);}
			function ResetMap(){

				Mapa.flyTo(Centro, 4);}
			function MapaCentralizado(){
				var att = Mapa.getCenter();
				if(att.lat == Centro[0] && att.lng == Centro[1])
					return true;
				return false;}


	    </script>


  	</body>
</html>