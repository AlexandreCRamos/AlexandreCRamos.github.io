<!DOCTYPE html>

<html>

  	<head>
	  	<meta charset="utf-8">
	    <title>Coronavirus no Brasil, por Alexandre Cajazeira Ramos</title>

    
	   
	    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>

	    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	   	<script src="https://d3js.org/colorbrewer.v1.min.js"></script>
	    <script src="js/crossfilter.js" charset="utf-8"></script>
	    <script src="js/dc.js" charset="utf-8"></script>
	    <script type="text/javascript" src="data/UF.js"></script>
	    <script type="text/javascript" src="dados.js"></script>

	    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="crossorigin="anonymous"></script>

		
		 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>

		<link rel="stylesheet" href="css/dc.css">
		<link rel="stylesheet" href="css/Covid19-Brasil.css">
	    <link rel="stylesheet" href="https://cajazeiraramos.github.io/css/style.css">
	    <link rel="stylesheet" href="https://cajazeiraramos.github.io/assets/site1.css">
	    
	    <!-- Slider exp -->
	 
  	</head>

  	<body>

        
		<nav class="nav"> 
			<ul class="list"> 
				<!-- <li class="item"> 
					<a class="link" href="https://cajazeiraramos.github.io/Covid19/piaui.html">Covid19 - PI</a> 
				</li> -->
				<li class="item"> 
					<a class="link" href="https://cajazeiraramos.github.io/">©Alexandre</a> 
				</li> 

			</ul>
		 </nav>


		<div id ="divGeral">
			<h1 id = "title">Coronavírus no Brasil - </h1>
			<div id="divCabeçalho">
				
			</div>
			<div id="divMapa"></div>
			
			
			<div class="slidecontainer">
				<h2>
					<label id = "dataLabel">Data: 10/04/2020</label>
					<input type="range" min="1" max="100" value="100" class="slider2" id="dataRange" onchange="trocaDia()">

					<button id= "ant" onclick="diaAnt()"><</button>
					<button id= "prox" onclick="proxDia()">></button>
					
					<script type="text/javascript">
						function proxDia(){
							var min = +document.getElementById("dataRange").min,
							max = +document.getElementById("dataRange").max,
							val = +document.getElementById("dataRange").value;
							// trocaDia(min);
							if(val == max){
								document.getElementById("dataRange").value = min;
								trocaDia();
							}else{
								document.getElementById("dataRange").value++;
								trocaDia();
							}}
						function diaAnt(){
							var min = +document.getElementById("dataRange").min,
							max = +document.getElementById("dataRange").max,
							val = +document.getElementById("dataRange").value;
							// trocaDia(min);
							if(val == min){
								document.getElementById("dataRange").value = max;
								trocaDia();
							}else{
								document.getElementById("dataRange").value--;
								trocaDia();
							}
						}
					</script>
				</h2>
			</div>

			<div id="divControles">
				<h2>
					Taxa / Letalidade
					<label class="switch"> 
						<input type="checkbox" id="trocaEscala" onchange="trocaEscala()">  
						<span class="slider round"></span> 
					</label>
					Estado / Região
					<label class="switch"> 
						<input type="checkbox" id="trocaEscala" onchange="trocaControleUF_RG()">  
						<span class="slider round"></span> 
					</label> 
					<button id= "limparFiltros" onclick="limparFiltros()">Limpar Filtros</button>
				</h2>
			</div>
			<div id="divDashBoard"></div>		
		</div>
		
		<script type="text/javascript">

  				var estados, regioes;

  				$.ajax({
					url: 'http://servicodados.ibge.gov.br/api/v2/malhas/?resolucao=2',
					type: 'GET',
					headers: {
				    	"Accept": 'application/vnd.geo+json'
				  	},
					success: function(result,status,xhr) {
						//called when successful
						estados = result;
						console.log('carregou',estados);
					},
					error: function(xhr,status,error) {
						console.log(error);
					}
				});
				$.ajax({
					url: 'http://servicodados.ibge.gov.br/api/v2/malhas/?resolucao=1',
					type: 'GET',
					headers: {
				    	"Accept": 'application/vnd.geo+json'
				  	},
					success: function(result,status,xhr) {
						//called when successful
						regioes = result;
						console.log('carregou',regioes);
					},
					error: function(xhr,status,error) {
						console.log(error);
					}
				});

				console.log(regioes);


  		</script>
		<script type="text/javascript" src="js/Covid19-Brasil.js"></script>
		
	    <footer class="footer-main" style="margin-top: 5%; font: 14px/14px Arial, Helvetica, sans-serif; font-weight: bold;"> Alexandre R Cajazeira Ramos © 2020 
	    	<p>
				*Fonte: <a href="https://covid.saude.gov.br/">Ministério da Saúde</a> e <a href="https://www.ibge.gov.br/apps/populacao/projecao/index.html?utm_source=portal&utm_medium=popclock&utm_campaign=novo_popclock">IBGE</a>
			</p>
	      </footer>

		<script type="text/javascript">
			
			let populacaoUF = d3.scale.ordinal()
				.domain(["AC","AL","AP","AM","BA","CE","DF","ES","GO","MA","MT","MS","MG","PA","PB","PR","PE","PI","RJ","RN","RS","RO","RR","SC","SP","SE","TO"])
				.range(['881935','3337357','845731','4144597','14873064','9132078','3015268','4018650','7018354','7075181','3484466','2778986','21168791','8602865','4018127','11433957','9557071','3273227','17264943','3506853','11377239','1777225','605761','7164788','45919049','2298696','1572866']),

			nomeUF = d3.scale.ordinal()
				.domain(["AC","AL","AP","AM","BA","CE","DF","ES","GO","MA","MT","MS","MG","PA","PB","PR","PE","PI","RJ","RN","RS","RO","RR","SC","SP","SE","TO"])
				.range(['Acre','Alagoas','Amapá','Amazonas','Bahia','Ceará','Distrito Federal','Espírito Santo','Goiás','Maranhão','Mato Grosso','Mato Grosso do Sul','Minas Gerais','Pará','Paraíba','Paraná','Pernambuco','Piauí','Rio de Janeiro','Rio Grande do Norte','Rio Grande do Sul','Rondônia','Roraima','Santa Catarina','São Paulo','Sergipe','Tocantins']),

			siglaRegiao = d3.scale.ordinal()
				.domain(["Sudeste", "Nordeste", "Sul", "Centro-Oeste", "Norte"])
				.range(['SE','NE','S','CO','N']),

			colorRegiao = d3.scale.ordinal()
				.domain(["Sudeste", "Nordeste", "Sul", "Centro-Oeste", "Norte"])
				.range(['#b3e2cd','#fdcdac','#cbd5e8','#f4cae4','#e6f5c9']);


			let centroMapa = [-13, -65],
				zoomMapa = 4;

			let Mapa = L.map('divMapa').setView(centroMapa, zoomMapa);

			L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {maxZoom: 18, attribution: `&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>`})
			.addTo(Mapa);


			let dataAtual, dataInicial, dataFinal, escala=false, controleUF_RG=false,
			 dtgFormat = d3.time.format("%d/%m/%Y");	

			dataInicial = dtgFormat.parse("30/01/2020");
			dataFinal = dtgFormat.parse("10/04/2020");
			dataAtual = dataFinal;

			var xMin = dataToNum(dataInicial),
			xMax = dataToNum(dataFinal);

			console.log(NumToData(xMin));

			document.getElementById("dataRange").min = xMin;
			document.getElementById("dataRange").max = xMax;
			document.getElementById("dataRange").value = xMax;

			function trocaEscala(){
				escala = !escala;
				render();
			}
			function trocaControleUF_RG(){
				controleUF_RG = !controleUF_RG;
				render();
			}


			function trocaDia(){
				
				var formatDay = d3.time.format("%d"),
				formatMonth = d3.time.format("%m"),
				formatYear = d3.time.format("%Y");

				var dataLabel = document.getElementById("dataLabel");
				

				var novaData = NumToData(document.getElementById("dataRange").value);
				var dia  = formatDay(novaData),
				mes = formatMonth(novaData),
				ano = formatYear(novaData);

				dataLabel.innerHTML = '<label id = "dataLabel"> Data: '+dia+"/"+mes+"/"+ano+'</label>';

				dataAtual = novaData;
				render();}


			function limparFiltros(){
				console.log("teste");
			}

			var dim_UF_Data, uf_Data_Casos; 

			d3.csv("data/minSaude.csv", function(data){
				data.forEach(function(d) {
					
					d.regiao = d.regiao;
					d.uf = d.estado;
					d.date = dtgFormat.parse(d.data);
					d.nome = nomeUF(d.uf);
					d.casosNovos = +d.casosNovos;
					d.casosAcumulados = +d.casosAcumulados;
					d.obitosNovos = +d.obitosNovos;
					d.obitosAcumulados = +d.obitosAcumulados;
					d.populacao = populacaoUF(d.uf);
					});
				var facts = crossfilter(data);
						
				dim_UF_Data = facts.dimension(function(d){
					return 'data='+d.date+'UF='+d.uf;
				});

				
			});

			function render(){
				console.log("Renderizando");
				console.log(dataAtual);
				console.log(escala);
				console.log(controleUF_RG);
				console.log(dim_UF_Data);
				
				uf_Data_Casos = dim_UF_Data.group().reduceSum(function(d){
					return d.casosAcumulados;
				});
				console.log(uf_Data_Casos.top(Infinity));

			}
			// console.log("teste");
			// console.log(regioes);

			// console.log(estados);
			// L.geoJson(estados, {

			// 		style: {fill:'blue'}

			// 				}).addTo(Mapa);	

			function dataToNum(inDate) {
			    var returnDateTime = 25569.0 + ((inDate.getTime() - (inDate.getTimezoneOffset() * 60 * 1000)) / (1000 * 60 * 60 * 24));
			    return returnDateTime.toString().substr(0,5);}
			function NumToData(serial) {
			   var utc_days  = Math.floor(serial - 25569);
			   var utc_value = utc_days * 86400;                                        
			   var date_info = new Date(utc_value * 1000);
			   var ano = date_info.getFullYear(),
			   mes = date_info.getMonth()+1,
			   dia =  date_info.getDate()+1;
			   return dtgFormat.parse(dia+"/"+mes+"/"+ano);}

		</script>
	   

  	</body>
</html>